%
g21
g0 z0
g0 a90y0

;align fixture fin with Z-axis

;align top/bottom faces perp to Y-axis TRAVEL
;probe top/bottom faces
;rotate 180
;align top/bottom faces perp to Y-axis TRAVEL
;probe top/bottom faces
;compare average Y-pos of 8 probed points to spindle to get y home offset

;align side faces perp to X-axis TRAVEL
;probe side faces
;rotate 180
;align side faces perp to X-axis TRAVEL
;probe side faces
;compare average X-pos of 8 probed points to spindle to get X home offset

#<aAngle> = 90
#<aAngleMeas> = 90
#<aErrAbs> = 0
o100 do
  g0 a85
  g0 a[#<aAngle>]

  M66 E0 L0
  o<v2_calib_find_pos_a> call [#<yPos>] [#<aAngle>]
  #<aAngleMeas> = [#<_value>]

  o101 if [#<aAngleMeas> GT 90]
    #<aErrAbs> = [#<aAngleMeas>]-90
  o101 else
    #<aErrAbs> = [90 - #<aAngleMeas>]  
  o101 endif
  #<aAngle> = [#<aAngle> - #<aAngleMeas>]
  
o100 while [#<aErrAbs> GT 0.003]

g0 b45
o<v2-calib-align-fixture-perp-y> call [45]
o<v2_calib_probe_home_offset_y> call [0][90][45]

g0 b45
o<v2-calib-align-fixture-perp-x> call [45]
o<v2_calib_probe_home_offset_x> call [0][90][45]

g0 b225
o<v2-calib-align-fixture-perp-y> call [225]
o<v2_calib_probe_home_offset_y> call [0][90][225]

g0 b225
o<v2-calib-align-fixture-perp-x> call [225]
o<v2_calib_probe_home_offset_x> call [0][90][225]




#<bAngle> = 225
#<bAngleMeas> = 225
#<bErrAbs> = 0
o104 do
  g0 b220
  g0 b[#<bAngle>]

  M66 E0 L0
  ;o<v2_calib_find_pos_b_at_90> call [#<yPos>] [#<bAngle>]
  o<v2_calib_find_pos_fixture_rel_x> call [#<yPos>] [#<bAngle>]
  #<bAngleErr> = [#<_value>]
  
  o105 if [#<bAngleErr> GT 0]
    #<bErrAbs> = [#<bAngleErr>]
  o105 else
    #<bErrAbs> = [0 - #<bAngleErr>]
  o105 endif
  #<bAngle> = [#<bAngle> - #<bAngleErr>]

  #<bAngleMeas> = [#<_value>]

  o105 if [#<bAngleMeas> GT 225]
    #<bErrAbs> = [#<bAngleMeas>]-225
  o105 else
    #<bErrAbs> = [225 - #<bAngleMeas>]  
  o105 endif
  #<bAngle> = [#<bAngle> - #<bAngleMeas>]
o104 while [#<bErrAbs> GT 0.003]
o<v2_calib_probe_home_offset_y> call [0][#<aAngle>][#<bAngle>]



g0 b225
#<bAngle> = 45
#<bAngleMeas> = 45
#<bErrAbs> = 0
o102 do
  g0 b40
  g0 b[#<bAngle>]

  M66 E0 L0
  o<v2_calib_find_pos_b_at_90> call [#<yPos>] [#<bAngle>]
  #<bAngleMeas> = [#<_value>]

  o103 if [#<bAngleMeas> GT 45]
    #<bErrAbs> = [#<bAngleMeas>]-45
  o103 else
    #<bErrAbs> = [45 - #<bAngleMeas>]  
  o103 endif
  #<bAngle> = [#<bAngle> - #<bAngleMeas>]
o102 while [#<bErrAbs> GT 0.003]
o<v2_calib_probe_home_offset_y> call [0][#<aAngle>][#<bAngle>]


g0 b225
#<bAngle> = 225
#<bAngleMeas> = 225
#<bErrAbs> = 0
o104 do
  g0 b220
  g0 b[#<bAngle>]

  M66 E0 L0
  o<v2_calib_find_pos_b_at_90> call [#<yPos>] [#<bAngle>]
  #<bAngleMeas> = [#<_value>]

  o105 if [#<bAngleMeas> GT 225]
    #<bErrAbs> = [#<bAngleMeas>]-225
  o105 else
    #<bErrAbs> = [225 - #<bAngleMeas>]  
  o105 endif
  #<bAngle> = [#<bAngle> - #<bAngleMeas>]
o104 while [#<bErrAbs> GT 0.003]

o<v2_calib_probe_home_offset_y> call [0][#<aAngle>][#<bAngle>]
%